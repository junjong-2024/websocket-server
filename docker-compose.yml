version: '2'
services:
  debait-db:
    image: mysql
    container_name: debait-db
    restart: always
    ports:
      - 3306:3306
    environment:
      MYSQL_ROOT_PASSWORD: junjong2024QAWSEDRF
      MYSQL_ROOT_HOST: '0.0.0.0'
      TZ: Asia/Seoul
    volumes:
      - ./db/mysql/data:/var/lib/mysql
      - ./db/mysql/init:/docker-entrypoint-initdb.d
    platform: linux/x86_64
    networks:
      - debait-net
  debait-renderer:
    image: video-renderer:latest
    container_name: debait-renderer
    volumes:
      - ./public/files:/app/files
    environment:
      REDIS_HOST: debait-redis
      API_HOST: debait-api-server:8080
    networks:
      - debait-net
    depends_on:
      - debait-redis
  debait-api-server:
    image: debait-api-server:latest
    container_name: debait-api-server
    environment:
      SOCKET_SERVER_URL: http://websocket:3000
    depends_on:
      - debait-db
    networks:
      - debait-net
  websocket:
    image: debait-websocket-server:latest
    container_name: websocket
    volumes:
      - ./public/files:/app/files
    ports:
      - '3001:3000'
      - 10000-10100:10000-10100/tcp
      - 10000-10100:10000-10100/udp
    environment:
      REDIS_HOST: debait-redis
      RECORD_FILE_LOCATION_PATH: ./files
      JWT_SECRET: 11111111sdfasfewdhtdfgdfaesg349dasdjasdijdsfdgddsadafsvfadsgsfaegfvdsafdsasdasdsadwefdefw
    networks:
      - debait-net
  debait-redis:
      image: redis:alpine
      container_name: debait-redis
      command: redis-server --port 6379
      networks:
        - debait-net
      labels:
        - "name=redis"
        - "mode=standalone"
      ports:
        - 6379:6379
  debait-nginx:
    image: nginx:1.25.3-alpine
    container_name: debait-nginx
    networks:
      - debait-net
    ports:
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/ssl
      - ./public:/public
    depends_on:
      - websocket

networks:
  debait-net:
    driver: bridge